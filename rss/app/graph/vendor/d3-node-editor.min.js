!function(global,factory){"object"==typeof exports&&"undefined"!=typeof module?factory(exports):"function"==typeof define&&define.amd?define(["exports"],factory):factory(global.D3NE=global.D3NE||{})}(this,function(exports){"use strict";function _inspect$1(input,depth){if(depth===undefined&&(depth=0),depth+=1,null===input)return"null";if(input===undefined)return"void";if("string"==typeof input||"number"==typeof input||"boolean"==typeof input)return void 0===input?"undefined":_typeof(input);if(Array.isArray(input)){if(input.length>0){if(depth>4)return"[...]";var first=_inspect$1(input[0],depth);return input.every(function(item){return _inspect$1(item,depth)===first})?first.trim()+"[]":"["+input.slice(0,15).map(function(item){return _inspect$1(item,depth)}).join(", ")+(input.length>=15?", ...":"")+"]"}return"Array"}var keys=Object.keys(input);if(!keys.length)return input.constructor&&input.constructor.name&&"Object"!==input.constructor.name?input.constructor.name:"Object";if(depth>4)return"{...}";var indent="  ".repeat(depth-1),entries=keys.slice(0,15).map(function(key){return(/^([A-Z_$][A-Z0-9_$]*)$/i.test(key)?key:JSON.stringify(key))+": "+_inspect$1(input[key],depth)+";"}).join("\n  "+indent);return keys.length>=15&&(entries+="\n  "+indent+"..."),input.constructor&&input.constructor.name&&"Object"!==input.constructor.name?input.constructor.name+" {\n  "+indent+entries+"\n"+indent+"}":"{\n  "+indent+entries+"\n"+indent+"}"}function _inspect$3(input,depth){if(depth===undefined&&(depth=0),depth+=1,null===input)return"null";if(input===undefined)return"void";if("string"==typeof input||"number"==typeof input||"boolean"==typeof input)return void 0===input?"undefined":_typeof(input);if(Array.isArray(input)){if(input.length>0){if(depth>4)return"[...]";var first=_inspect$3(input[0],depth);return input.every(function(item){return _inspect$3(item,depth)===first})?first.trim()+"[]":"["+input.slice(0,15).map(function(item){return _inspect$3(item,depth)}).join(", ")+(input.length>=15?", ...":"")+"]"}return"Array"}var keys=Object.keys(input);if(!keys.length)return input.constructor&&input.constructor.name&&"Object"!==input.constructor.name?input.constructor.name:"Object";if(depth>4)return"{...}";var indent="  ".repeat(depth-1),entries=keys.slice(0,15).map(function(key){return(/^([A-Z_$][A-Z0-9_$]*)$/i.test(key)?key:JSON.stringify(key))+": "+_inspect$3(input[key],depth)+";"}).join("\n  "+indent);return keys.length>=15&&(entries+="\n  "+indent+"..."),input.constructor&&input.constructor.name&&"Object"!==input.constructor.name?input.constructor.name+" {\n  "+indent+entries+"\n"+indent+"}":"{\n  "+indent+entries+"\n"+indent+"}"}function _inspect$4(input,depth){if(depth===undefined&&(depth=0),depth+=1,null===input)return"null";if(input===undefined)return"void";if("string"==typeof input||"number"==typeof input||"boolean"==typeof input)return void 0===input?"undefined":_typeof(input);if(Array.isArray(input)){if(input.length>0){if(depth>4)return"[...]";var first=_inspect$4(input[0],depth);return input.every(function(item){return _inspect$4(item,depth)===first})?first.trim()+"[]":"["+input.slice(0,15).map(function(item){return _inspect$4(item,depth)}).join(", ")+(input.length>=15?", ...":"")+"]"}return"Array"}var keys=Object.keys(input);if(!keys.length)return input.constructor&&input.constructor.name&&"Object"!==input.constructor.name?input.constructor.name:"Object";if(depth>4)return"{...}";var indent="  ".repeat(depth-1),entries=keys.slice(0,15).map(function(key){return(/^([A-Z_$][A-Z0-9_$]*)$/i.test(key)?key:JSON.stringify(key))+": "+_inspect$4(input[key],depth)+";"}).join("\n  "+indent);return keys.length>=15&&(entries+="\n  "+indent+"..."),input.constructor&&input.constructor.name&&"Object"!==input.constructor.name?input.constructor.name+" {\n  "+indent+entries+"\n"+indent+"}":"{\n  "+indent+entries+"\n"+indent+"}"}function _inspect$2(input,depth){if(depth===undefined&&(depth=0),depth+=1,null===input)return"null";if(input===undefined)return"void";if("string"==typeof input||"number"==typeof input||"boolean"==typeof input)return void 0===input?"undefined":_typeof(input);if(Array.isArray(input)){if(input.length>0){if(depth>4)return"[...]";var first=_inspect$2(input[0],depth);return input.every(function(item){return _inspect$2(item,depth)===first})?first.trim()+"[]":"["+input.slice(0,15).map(function(item){return _inspect$2(item,depth)}).join(", ")+(input.length>=15?", ...":"")+"]"}return"Array"}var keys=Object.keys(input);if(!keys.length)return input.constructor&&input.constructor.name&&"Object"!==input.constructor.name?input.constructor.name:"Object";if(depth>4)return"{...}";var indent="  ".repeat(depth-1),entries=keys.slice(0,15).map(function(key){return(/^([A-Z_$][A-Z0-9_$]*)$/i.test(key)?key:JSON.stringify(key))+": "+_inspect$2(input[key],depth)+";"}).join("\n  "+indent);return keys.length>=15&&(entries+="\n  "+indent+"..."),input.constructor&&input.constructor.name&&"Object"!==input.constructor.name?input.constructor.name+" {\n  "+indent+entries+"\n"+indent+"}":"{\n  "+indent+entries+"\n"+indent+"}"}function _inspect$5(input,depth){if(depth===undefined&&(depth=0),depth+=1,null===input)return"null";if(input===undefined)return"void";if("string"==typeof input||"number"==typeof input||"boolean"==typeof input)return void 0===input?"undefined":_typeof(input);if(Array.isArray(input)){if(input.length>0){if(depth>4)return"[...]";var first=_inspect$5(input[0],depth);return input.every(function(item){return _inspect$5(item,depth)===first})?first.trim()+"[]":"["+input.slice(0,15).map(function(item){return _inspect$5(item,depth)}).join(", ")+(input.length>=15?", ...":"")+"]"}return"Array"}var keys=Object.keys(input);if(!keys.length)return input.constructor&&input.constructor.name&&"Object"!==input.constructor.name?input.constructor.name:"Object";if(depth>4)return"{...}";var indent="  ".repeat(depth-1),entries=keys.slice(0,15).map(function(key){return(/^([A-Z_$][A-Z0-9_$]*)$/i.test(key)?key:JSON.stringify(key))+": "+_inspect$5(input[key],depth)+";"}).join("\n  "+indent);return keys.length>=15&&(entries+="\n  "+indent+"..."),input.constructor&&input.constructor.name&&"Object"!==input.constructor.name?input.constructor.name+" {\n  "+indent+entries+"\n"+indent+"}":"{\n  "+indent+entries+"\n"+indent+"}"}function _inspect(input,depth){if(depth===undefined&&(depth=0),depth+=1,null===input)return"null";if(input===undefined)return"void";if("string"==typeof input||"number"==typeof input||"boolean"==typeof input)return void 0===input?"undefined":_typeof(input);if(Array.isArray(input)){if(input.length>0){if(depth>4)return"[...]";var first=_inspect(input[0],depth);return input.every(function(item){return _inspect(item,depth)===first})?first.trim()+"[]":"["+input.slice(0,15).map(function(item){return _inspect(item,depth)}).join(", ")+(input.length>=15?", ...":"")+"]"}return"Array"}var keys=Object.keys(input);if(!keys.length)return input.constructor&&input.constructor.name&&"Object"!==input.constructor.name?input.constructor.name:"Object";if(depth>4)return"{...}";var indent="  ".repeat(depth-1),entries=keys.slice(0,15).map(function(key){return(/^([A-Z_$][A-Z0-9_$]*)$/i.test(key)?key:JSON.stringify(key))+": "+_inspect(input[key],depth)+";"}).join("\n  "+indent);return keys.length>=15&&(entries+="\n  "+indent+"..."),input.constructor&&input.constructor.name&&"Object"!==input.constructor.name?input.constructor.name+" {\n  "+indent+entries+"\n"+indent+"}":"{\n  "+indent+entries+"\n"+indent+"}"}function Group(scope,el,expression,env){var _this=this,group=env.changeDetector.locals.group;group.el=el,env.watch("node.style",function(){Object.assign(el.style,group.style)},{deep:!0}),d3.select(el).call(d3.drag().on("start",function(){d3.event.sourceEvent.shiftKey||_this.editor.selectGroup(group,d3.event.sourceEvent.ctrlKey)}).on("drag",function(){if(!_this.editor.readOnly){var k=_this.transform.k,dx=d3.event.dx/k,dy=d3.event.dy/k;_this.editor.selected.each(function(item){item.position[0]+=dx,item.position[1]+=dy}),_this.editor.selected.eachGroup(function(item){for(var i in item.nodes){var node=item.nodes[i];_this.editor.selected.contains(node)||(node.position[0]+=dx,node.position[1]+=dy)}}),_this.update()}}).on("end",function(){_this.editor.eventListener.trigger("change")}));var items={"Remove group":function(){_this.editor.removeGroup(group)}},onClick=function(subitem){subitem.call(_this),_this.contextMenu.hide()};d3.select(el).on("contextmenu",function(){if(!_this.editor.readOnly){var x=d3.event.clientX,y=d3.event.clientY;_this.editor.selectGroup(group),_this.contextMenu.show(x,y,items,!1,onClick),d3.event.preventDefault()}})}function GroupHandler(scope,el,arg,env){var _this2=this,group=env.changeDetector.locals.group,mousePrev=null;d3.select(el).call(d3.drag().on("start",function(){mousePrev=d3.mouse(_this2.container.node()),_this2.editor.selectGroup(group)}).on("drag",function(){if(!_this2.editor.readOnly){var zoom=d3.zoomTransform(_this2.container),mouse=d3.mouse(_this2.container.node()),deltax=(mouse[0]-mousePrev[0])/zoom.k,deltay=(mouse[1]-mousePrev[1])/zoom.k,deltaw=Math.max(0,group.width-group.minWidth),deltah=Math.max(0,group.height-group.minHeight);0!==deltaw&&(mousePrev[0]=mouse[0]),0!==deltah&&(mousePrev[1]=mouse[1]),arg.match("l")?(group.position[0]+=Math.min(deltaw,deltax),group.setWidth(group.width-deltax)):arg.match("r")&&group.setWidth(group.width+deltax),arg.match("t")?(group.position[1]+=Math.min(deltah,deltay),group.setHeight(group.height-deltay)):arg.match("b")&&group.setHeight(group.height+deltay),_this2.update()}}).on("end",function(){_this2.editor.nodes.forEach(function(node){group.isCoverNode(node)?group.addNode(node):group.removeNode(node)}),_this2.editor.eventListener.trigger("change"),_this2.update()}))}function GroupTitle(scope,el,expression,env){var group=env.changeDetector.locals.group;d3.select(el).on("click",function(){var title=prompt("Please enter title of the group",group.title);null!==title&&title.length>0&&(group.title=title),env.scan()})}function PickInput(scope,el,expression,env){var _this=this,input=env.changeDetector.locals.input;input.el=el,d3.select(el).on("mousedown",function(){if(!_this.editor.readOnly){if(d3.event.preventDefault(),null===_this.pickedOutput)return input.hasConnection()&&(_this.pickedOutput=input.connections[0].output,_this.editor.removeConnection(input.connections[0])),void _this.update();if(!input.multipleConnections&&input.hasConnection()&&_this.editor.removeConnection(input.connections[0]),!_this.pickedOutput.multipleConnections&&_this.pickedOutput.hasConnection()&&_this.editor.removeConnection(_this.pickedOutput.connections[0]),_this.pickedOutput.connectedTo(input)){var connection=input.connections.find(function(c){return c.output===_this.pickedOutput});_this.editor.removeConnection(connection)}_this.editor.connect(_this.pickedOutput,input),_this.pickedOutput=null,_this.update()}})}function PickOutput(scope,el,expression,env){var _this2=this,output=env.changeDetector.locals.output;output.el=el,d3.select(el).on("mousedown",function(){_this2.editor.readOnly||(_this2.pickedOutput=output)})}function Connection$1(scope,el,expression,env){var path=env.changeDetector.locals.path,connection=path.connection;if(connection){connection.el=el,env.watch("path.connection.style",function(){Object.assign(el.style,connection.style)},{deep:!0});var input=path.connection.input,output=path.connection.output;el.dataset.inputNode=input.node.id,el.dataset.inputIndex=input.node.inputs.indexOf(input),el.dataset.outputNode=output.node.id,el.dataset.outputIndex=output.node.outputs.indexOf(output),el.className.baseVal+=" output-"+output.socket.id.toLowerCase().replace(" ","-"),el.className.baseVal+=" input-"+input.socket.id.toLowerCase().replace(" ","-")}}function Control$1(scope,el,expression,env){var locals=env.changeDetector.locals,control=locals.input?locals.input.control:locals.control;el.innerHTML=control.html,control.handler(el.children[0],control)}function Item(scope,el,expression,env){var _this=this,l=env.changeDetector.locals,item=l.subitem||l.item,haveSubitems=item.constructor===Object;d3.select(el).on("click",function(){haveSubitems||_this.onClick(item),d3.event.stopPropagation()}).classed("have-subitems",haveSubitems)}function _inspect$7(input,depth){if(depth===undefined&&(depth=0),depth+=1,null===input)return"null";if(input===undefined)return"void";if("string"==typeof input||"number"==typeof input||"boolean"==typeof input)return void 0===input?"undefined":_typeof(input);if(Array.isArray(input)){if(input.length>0){if(depth>4)return"[...]";var first=_inspect$7(input[0],depth);return input.every(function(item){return _inspect$7(item,depth)===first})?first.trim()+"[]":"["+input.slice(0,15).map(function(item){return _inspect$7(item,depth)}).join(", ")+(input.length>=15?", ...":"")+"]"}return"Array"}var keys=Object.keys(input);if(!keys.length)return input.constructor&&input.constructor.name&&"Object"!==input.constructor.name?input.constructor.name:"Object";if(depth>4)return"{...}";var indent="  ".repeat(depth-1),entries=keys.slice(0,15).map(function(key){return(/^([A-Z_$][A-Z0-9_$]*)$/i.test(key)?key:JSON.stringify(key))+": "+_inspect$7(input[key],depth)+";"}).join("\n  "+indent);return keys.length>=15&&(entries+="\n  "+indent+"..."),input.constructor&&input.constructor.name&&"Object"!==input.constructor.name?input.constructor.name+" {\n  "+indent+entries+"\n"+indent+"}":"{\n  "+indent+entries+"\n"+indent+"}"}function Node$1(scope,el,expression,env){var _this=this,node=env.changeDetector.locals.node;node.el=el,env.watch("node.style",function(){Object.assign(el.style,node.style)},{deep:!0}),d3.select(el).call(d3.drag().on("start",function(){d3.select(el).raise(),d3.event.sourceEvent.shiftKey||_this.editor.selectNode(node,d3.event.sourceEvent.ctrlKey)}).on("drag",function(){if(!_this.editor.readOnly){var k=_this.transform.k,dx=d3.event.dx/k,dy=d3.event.dy/k;_this.editor.selected.each(function(item){item.position[0]+=dx,item.position[1]+=dy}),_this.editor.selected.eachGroup(function(item){for(var i in item.nodes){var _node=item.nodes[i];_this.editor.selected.contains(_node)||(_node.position[0]+=dx,_node.position[1]+=dy)}}),_this.update()}}).on("end",function(){_this.editor.groups.forEach(function(group){_this.editor.selected.eachNode(function(_node){var contain=group.containNode(_node),cover=group.isCoverNode(_node);contain&&!cover?group.removeNode(_node):!contain&&cover&&group.addNode(_node)})}),_this.editor.eventListener.trigger("change"),_this.update()})),window.addEventListener("load",function(){node.width=el.offsetWidth,node.height=el.offsetHeight});var items={"Remove node":function(){_this.editor.removeNode(node)},"Add to group":function(){var group=new Group$1("Group",{nodes:[node]});_this.editor.addGroup(group)}},onClick=function(subitem){subitem.call(_this),_this.contextMenu.hide()};d3.select(el).on("contextmenu",function(){if(!_this.editor.readOnly){var x=d3.event.clientX,y=d3.event.clientY;_this.editor.selectNode(node),_this.contextMenu.show(x,y,items,!1,onClick),d3.event.preventDefault()}})}function declareViewDirectives(view,alight){alight.directives.al.node=Node$1.bind(view),alight.directives.al.group=Group.bind(view),alight.directives.al.groupHandler=GroupHandler.bind(view),alight.directives.al.groupTitle=GroupTitle.bind(view),alight.directives.al.pickInput=PickInput.bind(view),alight.directives.al.pickOutput=PickOutput.bind(view),alight.directives.al.control=Control$1.bind(view),alight.directives.al.connection=Connection$1.bind(view)}function declareMenuDirectives(menu,alight){alight.directives.al.item=Item.bind(menu)}function _inspect$6(input,depth){if(depth===undefined&&(depth=0),depth+=1,null===input)return"null";if(input===undefined)return"void";if("string"==typeof input||"number"==typeof input||"boolean"==typeof input)return void 0===input?"undefined":_typeof(input);if(Array.isArray(input)){if(input.length>0){if(depth>4)return"[...]";var first=_inspect$6(input[0],depth);return input.every(function(item){return _inspect$6(item,depth)===first})?first.trim()+"[]":"["+input.slice(0,15).map(function(item){return _inspect$6(item,depth)}).join(", ")+(input.length>=15?", ...":"")+"]"}return"Array"}var keys=Object.keys(input);if(!keys.length)return input.constructor&&input.constructor.name&&"Object"!==input.constructor.name?input.constructor.name:"Object";if(depth>4)return"{...}";var indent="  ".repeat(depth-1),entries=keys.slice(0,15).map(function(key){return(/^([A-Z_$][A-Z0-9_$]*)$/i.test(key)?key:JSON.stringify(key))+": "+_inspect$6(input[key],depth)+";"}).join("\n  "+indent);return keys.length>=15&&(entries+="\n  "+indent+"..."),input.constructor&&input.constructor.name&&"Object"!==input.constructor.name?input.constructor.name+" {\n  "+indent+entries+"\n"+indent+"}":"{\n  "+indent+entries+"\n"+indent+"}"}function _inspect$8(input,depth){if(depth===undefined&&(depth=0),depth+=1,null===input)return"null";if(input===undefined)return"void";if("string"==typeof input||"number"==typeof input||"boolean"==typeof input)return void 0===input?"undefined":_typeof(input);if(Array.isArray(input)){if(input.length>0){if(depth>4)return"[...]";var first=_inspect$8(input[0],depth);return input.every(function(item){return _inspect$8(item,depth)===first})?first.trim()+"[]":"["+input.slice(0,15).map(function(item){return _inspect$8(item,depth)}).join(", ")+(input.length>=15?", ...":"")+"]"}return"Array"}var keys=Object.keys(input);if(!keys.length)return input.constructor&&input.constructor.name&&"Object"!==input.constructor.name?input.constructor.name:"Object";if(depth>4)return"{...}";var indent="  ".repeat(depth-1),entries=keys.slice(0,15).map(function(key){return(/^([A-Z_$][A-Z0-9_$]*)$/i.test(key)?key:JSON.stringify(key))+": "+_inspect$8(input[key],depth)+";"}).join("\n  "+indent);return keys.length>=15&&(entries+="\n  "+indent+"..."),input.constructor&&input.constructor.name&&"Object"!==input.constructor.name?input.constructor.name+" {\n  "+indent+entries+"\n"+indent+"}":"{\n  "+indent+entries+"\n"+indent+"}"}function _inspect$10(input,depth){if(depth===undefined&&(depth=0),depth+=1,null===input)return"null";if(input===undefined)return"void";if("string"==typeof input||"number"==typeof input||"boolean"==typeof input)return void 0===input?"undefined":_typeof(input);if(Array.isArray(input)){if(input.length>0){if(depth>4)return"[...]";var first=_inspect$10(input[0],depth);return input.every(function(item){return _inspect$10(item,depth)===first})?first.trim()+"[]":"["+input.slice(0,15).map(function(item){return _inspect$10(item,depth)}).join(", ")+(input.length>=15?", ...":"")+"]"}return"Array"}var keys=Object.keys(input);if(!keys.length)return input.constructor&&input.constructor.name&&"Object"!==input.constructor.name?input.constructor.name:"Object";if(depth>4)return"{...}";var indent="  ".repeat(depth-1),entries=keys.slice(0,15).map(function(key){return(/^([A-Z_$][A-Z0-9_$]*)$/i.test(key)?key:JSON.stringify(key))+": "+_inspect$10(input[key],depth)+";"}).join("\n  "+indent);return keys.length>=15&&(entries+="\n  "+indent+"..."),input.constructor&&input.constructor.name&&"Object"!==input.constructor.name?input.constructor.name+" {\n  "+indent+entries+"\n"+indent+"}":"{\n  "+indent+entries+"\n"+indent+"}"}function _inspect$11(input,depth){if(depth===undefined&&(depth=0),depth+=1,null===input)return"null";if(input===undefined)return"void";if("string"==typeof input||"number"==typeof input||"boolean"==typeof input)return void 0===input?"undefined":_typeof(input);if(Array.isArray(input)){if(input.length>0){if(depth>4)return"[...]";var first=_inspect$11(input[0],depth);return input.every(function(item){return _inspect$11(item,depth)===first})?first.trim()+"[]":"["+input.slice(0,15).map(function(item){return _inspect$11(item,depth)}).join(", ")+(input.length>=15?", ...":"")+"]"}return"Array"}var keys=Object.keys(input);if(!keys.length)return input.constructor&&input.constructor.name&&"Object"!==input.constructor.name?input.constructor.name:"Object";if(depth>4)return"{...}";var indent="  ".repeat(depth-1),entries=keys.slice(0,15).map(function(key){return(/^([A-Z_$][A-Z0-9_$]*)$/i.test(key)?key:JSON.stringify(key))+": "+_inspect$11(input[key],depth)+";"}).join("\n  "+indent);return keys.length>=15&&(entries+="\n  "+indent+"..."),input.constructor&&input.constructor.name&&"Object"!==input.constructor.name?input.constructor.name+" {\n  "+indent+entries+"\n"+indent+"}":"{\n  "+indent+entries+"\n"+indent+"}"}function _inspect$12(input,depth){if(depth===undefined&&(depth=0),depth+=1,null===input)return"null";if(input===undefined)return"void";if("string"==typeof input||"number"==typeof input||"boolean"==typeof input)return void 0===input?"undefined":_typeof(input);if(Array.isArray(input)){if(input.length>0){if(depth>4)return"[...]";var first=_inspect$12(input[0],depth);return input.every(function(item){return _inspect$12(item,depth)===first})?first.trim()+"[]":"["+input.slice(0,15).map(function(item){return _inspect$12(item,depth)}).join(", ")+(input.length>=15?", ...":"")+"]"}return"Array"}var keys=Object.keys(input);if(!keys.length)return input.constructor&&input.constructor.name&&"Object"!==input.constructor.name?input.constructor.name:"Object";if(depth>4)return"{...}";var indent="  ".repeat(depth-1),entries=keys.slice(0,15).map(function(key){return(/^([A-Z_$][A-Z0-9_$]*)$/i.test(key)?key:JSON.stringify(key))+": "+_inspect$12(input[key],depth)+";"}).join("\n  "+indent);return keys.length>=15&&(entries+="\n  "+indent+"..."),input.constructor&&input.constructor.name&&"Object"!==input.constructor.name?input.constructor.name+" {\n  "+indent+entries+"\n"+indent+"}":"{\n  "+indent+entries+"\n"+indent+"}"}function _inspect$9(input,depth){if(depth===undefined&&(depth=0),depth+=1,null===input)return"null";if(input===undefined)return"void";if("string"==typeof input||"number"==typeof input||"boolean"==typeof input)return void 0===input?"undefined":_typeof(input);if(Array.isArray(input)){if(input.length>0){if(depth>4)return"[...]";var first=_inspect$9(input[0],depth);return input.every(function(item){return _inspect$9(item,depth)===first})?first.trim()+"[]":"["+input.slice(0,15).map(function(item){return _inspect$9(item,depth)}).join(", ")+(input.length>=15?", ...":"")+"]"}return"Array"}var keys=Object.keys(input);if(!keys.length)return input.constructor&&input.constructor.name&&"Object"!==input.constructor.name?input.constructor.name:"Object";if(depth>4)return"{...}";var indent="  ".repeat(depth-1),entries=keys.slice(0,15).map(function(key){return(/^([A-Z_$][A-Z0-9_$]*)$/i.test(key)?key:JSON.stringify(key))+": "+_inspect$9(input[key],depth)+";"}).join("\n  "+indent);return keys.length>=15&&(entries+="\n  "+indent+"..."),input.constructor&&input.constructor.name&&"Object"!==input.constructor.name?input.constructor.name+" {\n  "+indent+entries+"\n"+indent+"}":"{\n  "+indent+entries+"\n"+indent+"}"}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},classCallCheck=function(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")},createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),inherits=function(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)},possibleConstructorReturn=function(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call},toConsumableArray=function(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++)arr2[i]=arr[i];return arr2}return Array.from(arr)},Module=function(){function Module(data,titlesInput,titlesOutput){classCallCheck(this,Module);var inputs=Module.extractNodes(data,titlesInput),outputs=Module.extractNodes(data,titlesOutput);this.inputs=[],this.outputs=[],this.keys={input:inputs.map(function(n){return n.data.name}),output:outputs.map(function(n){return n.data.name})}}return createClass(Module,[{key:"read",value:function(inputs){var _this=this;this.keys.input.forEach(function(key,i){_this.inputs[key]=inputs[i]})}},{key:"write",value:function(outputs){var _this2=this;this.keys.output.forEach(function(k,i){outputs[i]=_this2.outputs[k]})}}],[{key:"extractNodes",value:function(data,titles){return Object.keys(data.nodes).filter(function(k){return titles.includes(data.nodes[k].title)}).map(function(k){return data.nodes[k]}).sort(function(n1,n2){return n1.position[1]>n2.position[1]})}}]),Module}(),ModuleManager=function(){function ModuleManager(titlesInput,titlesOutput){classCallCheck(this,ModuleManager),this.engine=null,this.titlesInput=titlesInput,this.titlesOutput=titlesOutput}return createClass(ModuleManager,[{key:"getInputs",value:function(data){return Module.extractNodes(data,this.titlesInput).map(function(n){return{title:n.title,name:n.data.name}})}},{key:"getOutputs",value:function(data){return Module.extractNodes(data,this.titlesOutput).map(function(n){return{title:n.title,name:n.data.name}})}},{key:"workerModule",value:function(node,inputs,outputs){var data,m,engine;return regeneratorRuntime.async(function(_context){for(;;)switch(_context.prev=_context.next){case 0:return data=node.data.module.data,m=new Module(data,this.titlesInput,this.titlesOutput),engine=this.engine.clone(),m.read(inputs),_context.next=6,regeneratorRuntime.awrap(engine.process(data,null,m));case 6:m.write(outputs);case 7:case"end":return _context.stop()}},null,this)}},{key:"workerInputs",value:function(node,inputs,outputs,module){module&&(outputs[0]=module.inputs[node.data.name][0])}},{key:"workerOutputs",value:function(node,inputs,outputs,module){module&&(module.outputs[node.data.name]=inputs[0][0])}},{key:"setEngine",value:function(engine){this.engine=engine}}]),ModuleManager}(),Block=function(){function Block(Class){if(classCallCheck(this,Block),this.constructor===Block)throw new TypeError("Cannot construct Block instances");this.id=Block.incrementId(Class),this.position=[0,0],this.width=0,this.height=0,this.style={}}return createClass(Block,null,[{key:"incrementId",value:function(Class){return Class.latestId?Class.latestId++:Class.latestId=1,Class.latestId}}]),Block}(),Control=function(){function Control(html){var handler=arguments.length>1&&arguments[1]!==undefined?arguments[1]:function(){};if(classCallCheck(this,Control),"string"!=typeof html)throw new TypeError('Value of argument "html" violates contract.\n\nExpected:\nstring\n\nGot:\n'+_inspect$1(html));this.html=html,this.parent=null,this.handler=handler}return createClass(Control,[{key:"getNode",value:function(){if(null===this.parent)throw new Error("Control isn't added to Node/Input");return this.parent instanceof Node?this.parent:this.parent.node}},{key:"getData",value:function(key){return this.getNode().data[key]}},{key:"putData",value:function(key,data){this.getNode().data[key]=data}}]),Control}(),Connection=function(){function Connection(output,input){classCallCheck(this,Connection),this.output=output,this.input=input,this.style={},this.input.addConnection(this)}return createClass(Connection,[{key:"remove",value:function(){this.input.removeConnection(this),this.output.removeConnection(this)}}]),Connection}(),Socket=function(){function Socket(id,name,hint){if(classCallCheck(this,Socket),"string"!=typeof id)throw new TypeError('Value of argument "id" violates contract.\n\nExpected:\nstring\n\nGot:\n'+_inspect$3(id));if("string"!=typeof name)throw new TypeError('Value of argument "name" violates contract.\n\nExpected:\nstring\n\nGot:\n'+_inspect$3(name));if("string"!=typeof hint)throw new TypeError('Value of argument "hint" violates contract.\n\nExpected:\nstring\n\nGot:\n'+_inspect$3(hint));this.id=id,this.name=name,this.hint=hint,this.compatible=[]}return createClass(Socket,[{key:"combineWith",value:function(socket){if(!(socket instanceof Socket))throw new TypeError('Value of argument "socket" violates contract.\n\nExpected:\nSocket\n\nGot:\n'+_inspect$3(socket));this.compatible.push(socket)}},{key:"compatibleWith",value:function(socket){if(!(socket instanceof Socket))throw new TypeError('Value of argument "socket" violates contract.\n\nExpected:\nSocket\n\nGot:\n'+_inspect$3(socket));return this===socket||this.compatible.includes(socket)}}]),Socket}(),IO=function(){function IO(title,socket,multiConns){classCallCheck(this,IO),this.node=null,this.multipleConnections=multiConns,this.connections=[],this.title=title,this.socket=socket}return createClass(IO,[{key:"removeConnection",value:function(connection){if(!(connection instanceof Connection))throw new TypeError('Value of argument "connection" violates contract.\n\nExpected:\nConnection\n\nGot:\n'+_inspect$4(connection));this.connections.splice(this.connections.indexOf(connection),1)}}]),IO}(),Input=function(_IO){function Input(title,socket){var multiConns=arguments.length>2&&arguments[2]!==undefined&&arguments[2];if(classCallCheck(this,Input),"string"!=typeof title)throw new TypeError('Value of argument "title" violates contract.\n\nExpected:\nstring\n\nGot:\n'+_inspect$2(title));if(!(socket instanceof Socket))throw new TypeError('Value of argument "socket" violates contract.\n\nExpected:\nSocket\n\nGot:\n'+_inspect$2(socket));if("boolean"!=typeof multiConns)throw new TypeError('Value of argument "multiConns" violates contract.\n\nExpected:\nboolean\n\nGot:\n'+_inspect$2(multiConns));var _this=possibleConstructorReturn(this,(Input.__proto__||Object.getPrototypeOf(Input)).call(this,title,socket,multiConns));return _this.control=null,_this}return inherits(Input,_IO),createClass(Input,[{key:"hasConnection",value:function(){return this.connections.length>0}},{key:"addConnection",value:function(connection){if(!(connection instanceof Connection))throw new TypeError('Value of argument "connection" violates contract.\n\nExpected:\nConnection\n\nGot:\n'+_inspect$2(connection));if(!this.multipleConnections&&this.hasConnection())throw new Error("Multiple connections not allowed");this.connections.push(connection)}},{key:"addControl",value:function(control){if(!(control instanceof Control))throw new TypeError('Value of argument "control" violates contract.\n\nExpected:\nControl\n\nGot:\n'+_inspect$2(control));this.control=control,control.parent=this}},{key:"showControl",value:function(){return!this.hasConnection()&&null!==this.control}},{key:"toJSON",value:function(){return{connections:this.connections.map(function(c){return{node:c.output.node.id,output:c.output.node.outputs.indexOf(c.output)}})}}}]),Input}(IO),Output=function(_IO){function Output(title,socket){var multiConns=!(arguments.length>2&&arguments[2]!==undefined)||arguments[2];if(classCallCheck(this,Output),"string"!=typeof title)throw new TypeError('Value of argument "title" violates contract.\n\nExpected:\nstring\n\nGot:\n'+_inspect$5(title));if(!(socket instanceof Socket))throw new TypeError('Value of argument "socket" violates contract.\n\nExpected:\nSocket\n\nGot:\n'+_inspect$5(socket))
;if("boolean"!=typeof multiConns)throw new TypeError('Value of argument "multiConns" violates contract.\n\nExpected:\nboolean\n\nGot:\n'+_inspect$5(multiConns));return possibleConstructorReturn(this,(Output.__proto__||Object.getPrototypeOf(Output)).call(this,title,socket,multiConns))}return inherits(Output,_IO),createClass(Output,[{key:"hasConnection",value:function(){return this.connections.length>0}},{key:"connectTo",value:function(input){if(!(input instanceof Input))throw new TypeError('Value of argument "input" violates contract.\n\nExpected:\nInput\n\nGot:\n'+_inspect$5(input));if(!this.socket.compatibleWith(input.socket))throw new Error("Sockets not compatible");if(!input.multipleConnections&&input.hasConnection())throw new Error("Input already has one connection");if(!this.multipleConnections&&this.hasConnection())throw new Error("Output already has one connection");var connection=new Connection(this,input);return this.connections.push(connection),connection}},{key:"connectedTo",value:function(input){if(!(input instanceof Input))throw new TypeError('Value of argument "input" violates contract.\n\nExpected:\nInput\n\nGot:\n'+_inspect$5(input));return this.connections.some(function(item){return item.input===input})}},{key:"toJSON",value:function(){return{connections:this.connections.map(function(c){return{node:c.input.node.id,input:c.input.node.inputs.indexOf(c.input)}})}}}]),Output}(IO),Node=function(_Block){function Node(title){if(classCallCheck(this,Node),"string"!=typeof title)throw new TypeError('Value of argument "title" violates contract.\n\nExpected:\nstring\n\nGot:\n'+_inspect(title));var _this=possibleConstructorReturn(this,(Node.__proto__||Object.getPrototypeOf(Node)).call(this,Node));_this.group=null,_this.inputs=[],_this.outputs=[],_this.controls=[],_this.data={},_this.title=title;var _ref=[180,100];return _this.width=_ref[0],_this.height=_ref[1],_this}return inherits(Node,_Block),createClass(Node,[{key:"addControl",value:function(control){var index=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;if(!(control instanceof Control))throw new TypeError('Value of argument "control" violates contract.\n\nExpected:\nControl\n\nGot:\n'+_inspect(control));if(!(null==index||"number"==typeof index&&!isNaN(index)&&index>=0&&index<=255&&index===Math.floor(index)))throw new TypeError('Value of argument "index" violates contract.\n\nExpected:\n?uint8\n\nGot:\n'+_inspect(index));return control.parent=this,null!==index?this.controls.splice(index,0,control):this.controls.push(control),this}},{key:"addInput",value:function(input){var index=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;if(!(input instanceof Input))throw new TypeError('Value of argument "input" violates contract.\n\nExpected:\nInput\n\nGot:\n'+_inspect(input));if(!(null==index||"number"==typeof index&&!isNaN(index)&&index>=0&&index<=255&&index===Math.floor(index)))throw new TypeError('Value of argument "index" violates contract.\n\nExpected:\n?uint8\n\nGot:\n'+_inspect(index));if(null!==input.node)throw new Error("Input has already been added to the node");return input.node=this,null!==index?this.inputs.splice(index,0,input):this.inputs.push(input),this}},{key:"addOutput",value:function(output){var index=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;if(!(output instanceof Output))throw new TypeError('Value of argument "output" violates contract.\n\nExpected:\nOutput\n\nGot:\n'+_inspect(output));if(!(null==index||"number"==typeof index&&!isNaN(index)&&index>=0&&index<=255&&index===Math.floor(index)))throw new TypeError('Value of argument "index" violates contract.\n\nExpected:\n?uint8\n\nGot:\n'+_inspect(index));if(null!==output.node)throw new Error("Output has already been added to the node");return output.node=this,null!==index?this.outputs.splice(index,0,output):this.outputs.push(output),this}},{key:"getConnections",value:function(type){var conns=[];return"input"!==type&&type||this.inputs.map(function(input){input.connections.forEach(function(c){conns.push(c)})}),"output"!==type&&type||this.outputs.forEach(function(output){output.connections.forEach(function(c){conns.push(c)})}),conns}},{key:"inputsWithVisibleControl",value:function(){return this.inputs.filter(function(input){return input.showControl()})}},{key:"toJSON",value:function(){return{id:this.id,data:this.data,group:this.group?this.group.id:null,inputs:this.inputs.map(function(input){return input.toJSON()}),outputs:this.outputs.map(function(output){return output.toJSON()}),position:this.position,title:this.title}}}],[{key:"fromJSON",value:function(component,json){var node;return regeneratorRuntime.async(function(_context){for(;;)switch(_context.prev=_context.next){case 0:if(component instanceof Component){_context.next=2;break}throw new TypeError('Value of argument "component" violates contract.\n\nExpected:\nComponent\n\nGot:\n'+_inspect(component));case 2:if(json instanceof Object){_context.next=4;break}throw new TypeError('Value of argument "json" violates contract.\n\nExpected:\nObject\n\nGot:\n'+_inspect(json));case 4:return node=component.newNode(),node.id=json.id,node.data=json.data,Node.latestId=Math.max(node.id,Node.latestId),node.position=json.position,node.title=json.title,_context.next=12,regeneratorRuntime.awrap(component.builder(node));case 12:return _context.abrupt("return",node);case 13:case"end":return _context.stop()}},null,this)}}]),Node}(Block),defaultTemplate=function(locals){var pug_html="";try{var pug_debug_sources={};pug_html+='<div class="title">',pug_html+="{{node.title}}</div>",pug_html+="\x3c!-- Outputs--\x3e",pug_html+='<div al-repeat="output in node.outputs" style="text-align: right;">',pug_html+='<div class="output-title">',pug_html+="{{output.title}}</div>",pug_html+="<div class=\"socket output {{output.socket.id.toLowerCase().replace(' ','-')}}\" al-pick-output title=\"{{output.socket.name}}\n{{output.socket.hint}}\"></div></div>",pug_html+="\x3c!-- Controls--\x3e",pug_html+='<div class="control" al-repeat="control in node.controls" style="text-align: center;" :width="control.parent.width - 2 * control.margin" :height="control.height" al-control="control"></div>',pug_html+="\x3c!-- Inputs--\x3e",pug_html+='<div al-repeat="input in node.inputs" style="text-align: left;">',pug_html+="<div class=\"socket input {{input.socket.id.toLowerCase().replace(' ','-')}} {{input.multipleConnections?'multiple':''}}\" al-pick-input title=\"{{input.socket.name}}\n{{input.socket.hint}}\"></div>",pug_html+='<div class="input-title" al-if="!input.showControl()">',pug_html+="{{input.title}}</div>",pug_html+='<div class="input-control" al-if="input.showControl()" al-control="input.control"></div></div>'}catch(err){pug.rethrow(err,void 0,void 0,pug_debug_sources[void 0])}return pug_html}(),Component=function(){function Component(name,props){classCallCheck(this,Component),this.name=name,this.template=props.template||defaultTemplate,this.builder=props.builder,this.worker=props.worker}return createClass(Component,[{key:"newNode",value:function(){return new Node(this.name)}}]),Component}(),Utils=function(){function Utils(){classCallCheck(this,Utils)}return createClass(Utils,null,[{key:"nodesBBox",value:function(nodes){var min=function(arr){return Math.min.apply(Math,toConsumableArray(arr))},max=function(arr){return Math.max.apply(Math,toConsumableArray(arr))},left=min(nodes.map(function(node){return node.position[0]})),top=min(nodes.map(function(node){return node.position[1]})),right=max(nodes.map(function(node){return node.position[0]+node.width})),bottom=max(nodes.map(function(node){return node.position[1]+node.height}));return{left:left,right:right,top:top,bottom:bottom,width:Math.abs(left-right),height:Math.abs(top-bottom),getCenter:function(){return[(left+right)/2,(top+bottom)/2]}}}},{key:"getConnectionPath",value:function(a,b,produce){var _produce=produce.apply(undefined,toConsumableArray(a).concat(toConsumableArray(b))),points=_produce.points,curve=_produce.curve;switch(curve){case"linear":curve=d3.curveLinear;break;case"step":curve=d3.curveStep;break;case"basis":default:curve=d3.curveBasis}return this.pointsToPath(points,curve)}},{key:"pointsToPath",value:function(points,d3curve){var curve=d3curve(d3.path());curve.lineStart();for(var i=0;i<points.length;i++)curve.point.apply(curve,toConsumableArray(points[i]));return curve.lineEnd(),curve._context.toString()}},{key:"getOutputPosition",value:function(output){var node=output.node,el=output.el;return[node.position[0]+el.offsetLeft+el.offsetWidth/2,node.position[1]+el.offsetTop+el.offsetHeight/2]}},{key:"getInputPosition",value:function(input){var node=input.node,el=input.el;return[node.position[0]+el.offsetLeft+el.offsetWidth/2,node.position[1]+el.offsetTop+el.offsetHeight/2]}},{key:"isValidData",value:function(data){return"string"==typeof data.id&&this.isValidId(data.id)&&data.nodes instanceof Object&&(!data.groups||data.groups instanceof Object)}},{key:"isValidId",value:function(id){return/^[\w-]{3,}@[0-9]+\.[0-9]+\.[0-9]+$/.test(id)}},{key:"validate",value:function(id,data){var msg="",id1=id.split("@"),id2=data.id.split("@");return this.isValidData(data)||(msg+="Data is not suitable. "),id!==data.id&&(msg+="IDs not equal. "),id1[0]!==id2[0]&&(msg+="Names don't match. "),id1[1]!==id2[1]&&(msg+="Versions don't match"),{success:""===msg,msg:msg}}}]),Utils}(),Group$1=function(_Block){function Group(title,params){if(classCallCheck(this,Group),"string"!=typeof title)throw new TypeError('Value of argument "title" violates contract.\n\nExpected:\nstring\n\nGot:\n'+_inspect$7(title));if(!(params instanceof Object))throw new TypeError('Value of argument "params" violates contract.\n\nExpected:\nObject\n\nGot:\n'+_inspect$7(params));var _this=possibleConstructorReturn(this,(Group.__proto__||Object.getPrototypeOf(Group)).call(this,Group));return _this.title=title,_this.nodes=[],_this.setMinSizes(300,250),params.nodes?_this.coverNodes(params.nodes):(_this.position=params.position,_this.width=params.width,_this.height=params.height),_this}return inherits(Group,_Block),createClass(Group,[{key:"setMinSizes",value:function(width,height){this.minWidth=width,this.minHeight=height}},{key:"setWidth",value:function(w){if("number"!=typeof w)throw new TypeError('Value of argument "w" violates contract.\n\nExpected:\nnumber\n\nGot:\n'+_inspect$7(w));return this.width=Math.max(this.minWidth,w)}},{key:"setHeight",value:function(h){if("number"!=typeof h)throw new TypeError('Value of argument "h" violates contract.\n\nExpected:\nnumber\n\nGot:\n'+_inspect$7(h));return this.height=Math.max(this.minHeight,h)}},{key:"isCoverNode",value:function(node){if(!(node instanceof Node))throw new TypeError('Value of argument "node" violates contract.\n\nExpected:\nNode\n\nGot:\n'+_inspect$7(node));var gp=this.position,np=node.position;return np[0]>gp[0]&&np[1]>gp[1]&&np[0]+node.width<gp[0]+this.width&&np[1]+node.height<gp[1]+this.height}},{key:"coverNodes",value:function(nodes){if(!Array.isArray(nodes)||!nodes.every(function(item){return item instanceof Node}))throw new TypeError('Value of argument "nodes" violates contract.\n\nExpected:\nNode[]\n\nGot:\n'+_inspect$7(nodes));var self=this,bbox=Utils.nodesBBox(nodes);nodes.forEach(function(node){null!==node.group&&node.group.removeNode(node.group),self.addNode(node)}),this.position=[bbox.left-30,bbox.top-60],this.setWidth(bbox.right-bbox.left+60),this.setHeight(bbox.bottom-bbox.top+90)}},{key:"containNode",value:function(node){if(!(node instanceof Node))throw new TypeError('Value of argument "node" violates contract.\n\nExpected:\nNode\n\nGot:\n'+_inspect$7(node));return-1!==this.nodes.indexOf(node)}},{key:"addNode",value:function(node){if(!(node instanceof Node))throw new TypeError('Value of argument "node" violates contract.\n\nExpected:\nNode\n\nGot:\n'+_inspect$7(node));return!this.containNode(node)&&(null!==node.group&&node.group.removeNode(node),node.group=this,this.nodes.push(node),!0)}},{key:"removeNode",value:function(node){if(!(node instanceof Node))throw new TypeError('Value of argument "node" violates contract.\n\nExpected:\nNode\n\nGot:\n'+_inspect$7(node));this.containNode(node)&&(this.nodes.splice(this.nodes.indexOf(node),1),node.group=null)}},{key:"remove",value:function(){this.nodes.forEach(function(node){node.group=null})}},{key:"toJSON",value:function(){return{id:this.id,title:this.title,nodes:this.nodes.map(function(a){return a.id}),minWidth:this.minWidth,minHeight:this.minHeight,position:this.position,width:this.width,height:this.height}}}],[{key:"fromJSON",value:function(json){if(!(json instanceof Object))throw new TypeError('Value of argument "json" violates contract.\n\nExpected:\nObject\n\nGot:\n'+_inspect$7(json));var group=new Group(json.title,{position:json.position,width:json.width,height:json.height});return group.id=json.id,Group.latestId=Math.max(group.id,Group.latestId),group.minWidth=json.minWidth,group.minHeight=json.minHeight,group}}]),Group}(Block),template$1=function(locals){var pug_html="";try{var pug_debug_sources={};pug_html+='<div class="context-menu" :style.left="contextMenu.x+&quot;px&quot;" :style.top="contextMenu.y+&quot;px&quot;" @mouseleave="contextMenu.hide()" al-if="contextMenu.visible">',pug_html+='<div class="search item" al-if="contextMenu.searchBar">',pug_html+='<input al-value="filter"></div>',pug_html+='<div class="item" al-repeat="(name,item) in contextMenu.searchItems(filter)" al-item>',pug_html+="{{name}}",pug_html+='<div class="subitems" al-if="contextMenu.haveSubitems(item)">',pug_html+='<div class="item" al-repeat="(name,subitem) in item" al-item>',pug_html+="{{name}}</div></div></div></div>"}catch(err){pug.rethrow(err,void 0,void 0,pug_debug_sources[void 0])}return pug_html},ContextMenu=function(){function ContextMenu(items){var searchBar=!(arguments.length>1&&arguments[1]!==undefined)||arguments[1];if(classCallCheck(this,ContextMenu),!(items instanceof Object))throw new TypeError('Value of argument "items" violates contract.\n\nExpected:\nObject\n\nGot:\n'+_inspect$6(items));if("boolean"!=typeof searchBar)throw new TypeError('Value of argument "searchBar" violates contract.\n\nExpected:\nboolean\n\nGot:\n'+_inspect$6(searchBar));this.visible=!1,this.x=0,this.y=0,this["default"]={items:items,searchBar:searchBar,onClick:function(){throw new TypeError("onClick should be overrided")}},this.bindTemplate(template$1())}return createClass(ContextMenu,[{key:"bindTemplate",value:function(t){this.dom=d3.select("body").append("div"),this.dom.node().setAttribute("tabindex",1),this.dom.html(t),declareMenuDirectives(this,alight),this.$cd=alight(this.dom.node(),{contextMenu:this})}},{key:"searchItems",value:function(filter){var _this=this;if(null!=filter&&"string"!=typeof filter)throw new TypeError('Value of argument "filter" violates contract.\n\nExpected:\n?string\n\nGot:\n'+_inspect$6(filter));var regex=new RegExp(filter,"i"),items={};return Object.keys(this.items).forEach(function(key){var item=_this.items[key];if(item.constructor===Object){var subitems=Object.keys(item).filter(function(subitem){return regex.test(subitem)});subitems.length>0&&(items[key]={},subitems.forEach(function(sumitem){items[key][sumitem]=item[sumitem]}))}else regex.test(key)&&(items[key]=item)}),items}},{key:"haveSubitems",value:function(item){return item.constructor===Object}},{key:"isVisible",value:function(){return this.visible}},{key:"show",value:function(x,y){var items=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null,searchBar=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null,onClick=arguments.length>4&&arguments[4]!==undefined?arguments[4]:null;if("number"!=typeof x)throw new TypeError('Value of argument "x" violates contract.\n\nExpected:\nnumber\n\nGot:\n'+_inspect$6(x));if("number"!=typeof y)throw new TypeError('Value of argument "y" violates contract.\n\nExpected:\nnumber\n\nGot:\n'+_inspect$6(y));if(!(null==items||items instanceof Object))throw new TypeError('Value of argument "items" violates contract.\n\nExpected:\n?Object\n\nGot:\n'+_inspect$6(items));if(null!=searchBar&&"boolean"!=typeof searchBar)throw new TypeError('Value of argument "searchBar" violates contract.\n\nExpected:\n?boolean\n\nGot:\n'+_inspect$6(searchBar));this.visible=!0,this.items=items||this["default"].items,this.searchBar=searchBar||this["default"].searchBar,this.onClick=onClick||this["default"].onClick,this.x=x,this.y=y,this.$cd.scan()}},{key:"hide",value:function(){this.visible=!1,this.$cd.scan()}}]),ContextMenu}(),p=function(v){return parseInt(v)},eqArr=function(ar1,ar2){return ar1.every(function(v,i){return v===ar2[i]})},eqObj=function(o1,o2){return JSON.stringify(o1)===JSON.stringify(o2)},eqCon=function(c1,c2,target){return c1.node===c2.node&&c1[target]===c2[target]},diffCons=function(cons1,cons2){return{removed:cons1.filter(function(c1){return!cons2.some(function(c2){return eqCon(c1,c2,"input")})}),added:cons2.filter(function(c2){return!cons1.some(function(c1){return eqCon(c1,c2,"input")})})}},Diff=function(){function Diff(data1,data2){classCallCheck(this,Diff),this.a=data1,this.b=data2}return createClass(Diff,[{key:"compare",value:function(){var a=this.a,b=this.b,k1=Object.keys(a.nodes),k2=Object.keys(b.nodes),removed=k1.filter(function(k){return!k2.includes(k)}).map(p),added=k2.filter(function(k){return!k1.includes(k)}).map(p),stayed=k1.filter(function(k){return k2.includes(k)}).map(p);return{removed:removed,added:added,moved:stayed.filter(function(id){var p1=a.nodes[id].position,p2=b.nodes[id].position;return!eqArr(p1,p2)}),datachanged:stayed.filter(function(id){var d1=a.nodes[id].data,d2=b.nodes[id].data;return!eqObj(d1,d2)}),connects:stayed.reduce(function(arr,id){var o1=a.nodes[id].outputs,o2=b.nodes[id].outputs,output=o1.map(function(out,i){return Object.assign({output:i},diffCons(out.connections,o2[i].connections))}).filter(function(diff){return 0!==diff.added.length||0!==diff.removed.length});return[].concat(toConsumableArray(arr),toConsumableArray(output.map(function(o){return o.node=id,o})))},[])}}}]),Diff}(),State={AVALIABLE:0,PROCESSED:1,ABORT:2},Engine=function(){function Engine(id,components){if(classCallCheck(this,Engine),"string"!=typeof id)throw new TypeError('Value of argument "id" violates contract.\n\nExpected:\nstring\n\nGot:\n'+_inspect$8(id));if(!Array.isArray(components)||!components.every(function(item){return item instanceof Component}))throw new TypeError('Value of argument "components" violates contract.\n\nExpected:\nComponent[]\n\nGot:\n'+_inspect$8(components));if(!Utils.isValidId(id))throw new Error("ID should be valid to name@0.1.0 format");this.id=id,this.components=components,this.args=[],this.data=null,this.state=State.AVALIABLE,this.onAbort=function(){}}return createClass(Engine,[{key:"clone",value:function(){return new Engine(this.id,this.components)}},{key:"processStart",value:function(){return this.state===State.AVALIABLE?(this.state=State.PROCESSED,!0):this.state!==State.ABORT&&(console.warn("The process is busy and has not been restarted. Use abort() to force it to complete"),!1)}},{key:"processDone",value:function(){var success=this.state!==State.ABORT;return this.state=State.AVALIABLE,success||(this.onAbort(),this.onAbort=function(){}),success}},{key:"abort",value:function(){var _this=this;return regeneratorRuntime.async(function(_context){for(;;)switch(_context.prev=_context.next){case 0:return _context.abrupt("return",new Promise(function(ret){_this.state===State.PROCESSED?(_this.state=State.ABORT,_this.onAbort=ret):_this.state===State.ABORT?(_this.onAbort(),_this.onAbort=ret):ret()}));case 1:case"end":return _context.stop()}},null,this)}},{key:"lock",value:function(node){return regeneratorRuntime.async(function(_context2){for(;;)switch(_context2.prev=_context2.next){case 0:return _context2.abrupt("return",new Promise(function(res){node.unlockPool=node.unlockPool||[],node.busy&&!node.outputData?node.unlockPool.push(res):res(),node.busy=!0}));case 1:case"end":return _context2.stop()}},null,this)}},{key:"unlock",value:function(node){node.unlockPool.forEach(function(a){return a()}),node.unlockPool=[],node.busy=!1}},{key:"extractInputData",value:function(node){var _this2=this;return regeneratorRuntime.async(function(_context5){for(;;)switch(_context5.prev=_context5.next){case 0:return _context5.next=2,regeneratorRuntime.awrap(Promise.all(node.inputs.map(function(input){var conns,connData;return regeneratorRuntime.async(function(_context4){for(;;)switch(_context4.prev=_context4.next){case 0:return conns=input.connections,_context4.next=3,regeneratorRuntime.awrap(Promise.all(conns.map(function(c){var outputs;return regeneratorRuntime.async(function(_context3){for(;;)switch(_context3.prev=_context3.next){case 0:return _context3.next=2,regeneratorRuntime.awrap(_this2.processNode(_this2.data.nodes[c.node]));case 2:if(outputs=_context3.sent){_context3.next=7;break}_this2.abort(),_context3.next=8;break;case 7:return _context3.abrupt("return",outputs[c.output]);case 8:case"end":return _context3.stop()}},null,_this2)})));case 3:return connData=_context4.sent,_context4.abrupt("return",connData);case 5:case"end":return _context4.stop()}},null,_this2)})));case 2:return _context5.abrupt("return",_context5.sent);case 3:case"end":return _context5.stop()}},null,this)}},{key:"processNode",value:function(node){var inputData,key,component;return regeneratorRuntime.async(function(_context6){for(;;)switch(_context6.prev=_context6.next){case 0:if(this.state!==State.ABORT&&node){_context6.next=2;break}return _context6.abrupt("return",null);case 2:return _context6.next=4,regeneratorRuntime.awrap(this.lock(node));case 4:if(node.outputData){_context6.next=22;break}return _context6.next=7,regeneratorRuntime.awrap(this.extractInputData(node));case 7:return inputData=_context6.sent,node.outputData=node.outputs.map(function(){return null}),key=node.title,component=this.components.find(function(c){return c.name===key}),_context6.prev=11,_context6.next=14,regeneratorRuntime.awrap(component.worker.apply(component,[node,inputData,node.outputData].concat(toConsumableArray(this.args))));case 14:_context6.next=20;break;case 16:_context6.prev=16,_context6.t0=_context6["catch"](11),this.abort(),console.warn(_context6.t0);case 20:if(node.outputData.length===node.outputs.length){_context6.next=22;break}throw new Error("Output data does not correspond to number of outputs");case 22:return this.unlock(node),_context6.abrupt("return",node.outputData);case 24:case"end":return _context6.stop()}},null,this,[[11,16]])}},{key:"forwardProcess",value:function(node){var _this3=this;return regeneratorRuntime.async(function(_context9){for(;;)switch(_context9.prev=_context9.next){case 0:if(this.state!==State.ABORT){_context9.next=2;break}return _context9.abrupt("return",null);case 2:return _context9.next=4,regeneratorRuntime.awrap(Promise.all(node.outputs.map(function(output){return regeneratorRuntime.async(function(_context8){for(;;)switch(_context8.prev=_context8.next){case 0:return _context8.next=2,regeneratorRuntime.awrap(Promise.all(output.connections.map(function(c){return regeneratorRuntime.async(function(_context7){for(;;)switch(_context7.prev=_context7.next){case 0:return _context7.next=2,regeneratorRuntime.awrap(_this3.processNode(_this3.data.nodes[c.node]));case 2:return _context7.next=4,regeneratorRuntime.awrap(_this3.forwardProcess(_this3.data.nodes[c.node]));case 4:case"end":return _context7.stop()}},null,_this3)})));case 2:return _context8.abrupt("return",_context8.sent);case 3:case"end":return _context8.stop()}},null,_this3)})));case 4:return _context9.abrupt("return",_context9.sent);case 5:case"end":return _context9.stop()}},null,this)}},{key:"copy",value:function(data){return data=Object.assign({},data),data.nodes=Object.assign({},data.nodes),Object.keys(data.nodes).forEach(function(key){data.nodes[key]=Object.assign({},data.nodes[key])}),data}},{key:"process",value:function(data){for(var startId=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null,_len=arguments.length,args=Array(_len>2?_len-2:0),_key=2;_key<_len;_key++)args[_key-2]=arguments[_key];var checking,startNode,i,node;return regeneratorRuntime.async(function(_context10){for(;;)switch(_context10.prev=_context10.next){case 0:if(data instanceof Object){_context10.next=2;break}throw new TypeError('Value of argument "data" violates contract.\n\nExpected:\nObject\n\nGot:\n'+_inspect$8(data));case 2:if(null==startId||"number"==typeof startId){_context10.next=4;break}throw new TypeError('Value of argument "startId" violates contract.\n\nExpected:\n?number\n\nGot:\n'+_inspect$8(startId));case 4:if(this.processStart()){_context10.next=6;break}return _context10.abrupt("return");case 6:if(checking=Utils.validate(this.id,data),checking.success){_context10.next=9;break}throw new Error(checking.msg);case 9:if(this.data=this.copy(data),this.args=args,!startId){_context10.next=19;break}if(startNode=this.data.nodes[startId]){_context10.next=15;break}throw new Error("Node with such id not found");case 15:return _context10.next=17,regeneratorRuntime.awrap(this.processNode(startNode));case 17:return _context10.next=19,regeneratorRuntime.awrap(this.forwardProcess(startNode));case 19:_context10.t0=regeneratorRuntime.keys(this.data.nodes);case 20:if((_context10.t1=_context10.t0()).done){_context10.next=30;break}if(i=_context10.t1.value,"undefined"!=typeof this.data.nodes[i].outputData){_context10.next=28;break}return node=this.data.nodes[i],_context10.next=26,regeneratorRuntime.awrap(this.processNode(node));case 26:return _context10.next=28,regeneratorRuntime.awrap(this.forwardProcess(node));case 28:_context10.next=20;break;case 30:return _context10.abrupt("return",this.processDone()?"success":"aborted");case 31:case"end":return _context10.stop()}},null,this)}}]),Engine}(),template$2=function(locals){var pug_html="";try{var pug_debug_sources={};pug_html+="\x3c!-- Groups--\x3e",pug_html+='<div class="group" al-repeat="group in editor.groups" :style.transform="&quot;translate(&quot;+group.position[0]+&quot;px,&quot;+group.position[1]+&quot;px)&quot;" :style.width="group.width+&quot;px&quot;" :style.height="group.height+&quot;px&quot;" al-group :class.selected="editor.selected.contains(group)">',pug_html+='<div class="group-title" al-group-title>',pug_html+="{{group.title}}</div>",pug_html+='<div class="group-handler right bottom" al-group-handler="rb"></div>',pug_html+='<div class="group-handler left top" al-group-handler="lt"></div>',pug_html+='<div class="group-handler left bottom" al-group-handler="lb"></div>',pug_html+='<div class="group-handler right top" al-group-handler="rt"></div></div>',pug_html+="\x3c!-- Connections--\x3e",pug_html+='<svg class="connections">',pug_html+='<path class="connection" al-repeat="path in editor.paths" :d="path.d" al-connection :class.selected="path.selected"></path></svg>',pug_html+="\x3c!-- Nodes--\x3e",pug_html+="<div class=\"node {{editor.selected.contains(node)?'selected':''}} {{node.title.toLowerCase().replace(' ','-')}}\" al-repeat=\"node in editor.nodes\" :style.transform=\"&quot;translate(&quot;+node.position[0]+&quot;px,&quot;+node.position[1]+&quot;px)&quot;\" al-node :data-id=\"node.id\">",pug_html+='<div al-html="editor.view.getTemplate(node)"></div></div>'}catch(err){pug.rethrow(err,void 0,void 0,pug_debug_sources[void 0])}return pug_html},EditorView=function(){function EditorView(editor,container,menu){var _this=this;if(classCallCheck(this,EditorView),!(editor instanceof NodeEditor))throw new TypeError('Value of argument "editor" violates contract.\n\nExpected:\nNodeEditor\n\nGot:\n'+_inspect$10(editor));if(!(container instanceof HTMLElement))throw new TypeError('Value of argument "container" violates contract.\n\nExpected:\nHTMLElement\n\nGot:\n'+_inspect$10(container));if(!(menu instanceof ContextMenu))throw new TypeError('Value of argument "menu" violates contract.\n\nExpected:\nContextMenu\n\nGot:\n'+_inspect$10(menu));this.editor=editor,this.pickedOutput=null,this.container=d3.select(container).attr("tabindex",1),this.mouse=[0,0],this.transform=d3.zoomIdentity,this.contextMenu=menu,this.container.on("click",function(){_this.container.node()===d3.event.target&&_this.areaClick()}),this.view=this.container.append("div").style("transform-origin","0 0").style("width",1).style("height",1),this.zoom=d3.zoom().on("zoom",function(){_this.transform=d3.event.transform,_this.update(),_this.editor.eventListener.trigger("transform",_this.transform)}),this.container.call(this.zoom),this.setScaleExtent(.1,1);var size=Math.pow(2,12);this.setTranslateExtent(-size,-size,size,size),d3.select(window).on("mousemove.d3ne"+editor._id,function(){var k=_this.transform.k,position=d3.mouse(_this.view.node());_this.mouse=[position[0]/k,position[1]/k],_this.update()}).on("keydown.d3ne"+editor._id,function(e){_this.container.node()===document.activeElement&&editor.keyDown(e)}).on("resize.d3ne"+editor._id,this.resize.bind(this)),this.view.html(template$2());var al=alight.makeInstance();declareViewDirectives(this,al),this.$cd=al(this.view.node(),{editor:editor})}return createClass(EditorView,[{key:"getTemplate",value:function(node){return this.editor.components.find(function(c){return c.name===node.title}).template}},{key:"resize",value:function(){var width=this.container.node().parentElement.clientWidth,height=this.container.node().parentElement.clientHeight;this.container.style("width",width+"px").style("height",height+"px"),this.update()}},{key:"connectionProducer",value:function(x1,y1,x2,y2){var offsetX=.3*Math.abs(x1-x2),offsetY=.1*(y2-y1);return{points:[[x1,y1],[x1+offsetX,y1+offsetY],[x2-offsetX,y2-offsetY],[x2,y2]],curve:"basis"}}},{key:"updateConnections",value:function(){var _this2=this,pathData=[];if(this.editor.nodes.forEach(function(node){node.getConnections("output").forEach(function(con){var output=con.output,input=con.input;input.el&&pathData.push({connection:con,d:Utils.getConnectionPath(Utils.getOutputPosition(output),Utils.getInputPosition(input),_this2.connectionProducer)})})}),null!==this.pickedOutput&&this.pickedOutput.el){var output=this.pickedOutput,input=this.mouse;pathData.push({selected:!0,d:Utils.getConnectionPath(Utils.getOutputPosition(output),input,this.connectionProducer)})}this.editor.paths=pathData}},{key:"update",value:function(){var t=this.transform;this.view.style("transform","translate("+t.x+"px, "+t.y+"px) scale("+t.k+")"),this.updateConnections(),this.$cd.scan()}},{key:"assignContextMenuHandler",value:function(){var _this3=this;this.contextMenu["default"].onClick=function(item){var node;return regeneratorRuntime.async(function(_context){for(;;)switch(_context.prev=_context.next){case 0:if(!(item instanceof Component)){_context.next=8;break}return node=item.newNode(),_context.next=4,regeneratorRuntime.awrap(item.builder(node));case 4:_this3.editor.addNode(node,!0),_this3.editor.selectNode(node),_context.next=9;break;case 8:item();case 9:_this3.contextMenu.hide();case 10:case"end":return _context.stop()}},null,_this3)}}},{key:"areaClick",value:function(){this.editor.readOnly||(null===this.pickedOutput||d3.event.ctrlKey?this.contextMenu.visible?this.contextMenu.hide():(this.assignContextMenuHandler(),this.contextMenu.show(d3.event.pageX,d3.event.pageY)):this.pickedOutput=null,this.update())}},{key:"zoomAt",value:function(nodes){if(!Array.isArray(nodes)||!nodes.every(function(item){return item instanceof Node}))throw new TypeError('Value of argument "nodes" violates contract.\n\nExpected:\nNode[]\n\nGot:\n'+_inspect$10(nodes));if(0!==nodes.length){var w=this.container.node().clientWidth,h=this.container.node().clientHeight,bbox=Utils.nodesBBox(nodes),kw=w/bbox.width,kh=h/bbox.height,k=Math.min(kh,kw,1),center=bbox.getCenter(),win=[w/2,h/2];k*=.9,this.translate(win[0]-center[0]*k,win[1]-center[1]*k),this.scale(k)}}},{key:"translate",value:function(x,y){this.transform.x=x,this.transform.y=y,this.update()}},{key:"scale",value:function(_scale){this.transform.k=_scale,this.update()}},{
key:"setScaleExtent",value:function(scaleMin,scaleMax){if("number"!=typeof scaleMin)throw new TypeError('Value of argument "scaleMin" violates contract.\n\nExpected:\nnumber\n\nGot:\n'+_inspect$10(scaleMin));if("number"!=typeof scaleMax)throw new TypeError('Value of argument "scaleMax" violates contract.\n\nExpected:\nnumber\n\nGot:\n'+_inspect$10(scaleMax));this.zoom.scaleExtent([scaleMin,scaleMax])}},{key:"setTranslateExtent",value:function(left,top,right,bottom){if("number"!=typeof left)throw new TypeError('Value of argument "left" violates contract.\n\nExpected:\nnumber\n\nGot:\n'+_inspect$10(left));if("number"!=typeof top)throw new TypeError('Value of argument "top" violates contract.\n\nExpected:\nnumber\n\nGot:\n'+_inspect$10(top));if("number"!=typeof right)throw new TypeError('Value of argument "right" violates contract.\n\nExpected:\nnumber\n\nGot:\n'+_inspect$10(right));if("number"!=typeof bottom)throw new TypeError('Value of argument "bottom" violates contract.\n\nExpected:\nnumber\n\nGot:\n'+_inspect$10(bottom));this.zoom.translateExtent([[left,top],[right,bottom]])}}]),EditorView}(),EventListener=function(){function EventListener(){classCallCheck(this,EventListener),this.events={nodecreate:[],groupcreate:[],connectioncreate:[],noderemove:[],groupremove:[],connectionremove:[],nodeselect:[],groupselect:[],error:[],change:[],transform:[]},this.persistent=!0}return createClass(EventListener,[{key:"on",value:function(names,handler){var _this=this;if("string"!=typeof names)throw new TypeError('Value of argument "names" violates contract.\n\nExpected:\nstring\n\nGot:\n'+_inspect$11(names));if("function"!=typeof handler)throw new TypeError('Value of argument "handler" violates contract.\n\nExpected:\n() => {}\n\nGot:\n'+_inspect$11(handler));return names.split(" ").forEach(function(name){if(!_this.events[name])throw new Error("The event "+name+" does not exist");_this.events[name].push(handler)}),this}},{key:"trigger",value:function(name,param){var _this2=this;if("string"!=typeof name)throw new TypeError('Value of argument "name" violates contract.\n\nExpected:\nstring\n\nGot:\n'+_inspect$11(name));if(!(name in this.events))throw new Error("The event "+name+" cannot be triggered");return this.events[name].reduce(function(r,e){return!1!==e(param,_this2.persistent)&&r},!0)}}]),EventListener}(),Command=function Command(exec,undo,args){classCallCheck(this,Command),this.exec=function(){exec.apply(undefined,toConsumableArray(args))},this.undo=function(){undo.apply(undefined,toConsumableArray(args))},this.a=args[0]},History=function(){function History(editor){classCallCheck(this,History),this.editor=editor,this.list=[],this._locked=!1,this.position=-1}return createClass(History,[{key:"add",value:function(exec,undo,args){this._locked||(this.position++,this.list.splice(this.position),this.list.push(new Command(exec,undo,args)))}},{key:"undo",value:function(){this.position<0||(this._locked=!0,this.list[this.position--].undo(),this._locked=!1)}},{key:"redo",value:function(){this.position+1>=this.list.length||(this._locked=!0,this.list[++this.position].exec(),this._locked=!1)}}]),History}(),Selected=function(){function Selected(){classCallCheck(this,Selected),this.list=[]}return createClass(Selected,[{key:"add",value:function(item){var accumulate=arguments.length>1&&arguments[1]!==undefined&&arguments[1];if(!(item instanceof Node||item instanceof Group$1))throw new TypeError('Value of argument "item" violates contract.\n\nExpected:\nNode | Group\n\nGot:\n'+_inspect$12(item));accumulate?this.contains(item)?this.remove(item):this.list.push(item):this.list=[item]}},{key:"clear",value:function(){var _this=this;this.each(function(item){_this.remove(item)})}},{key:"remove",value:function(item){this.list.splice(this.list.indexOf(item),1)}},{key:"contains",value:function(item){return-1!==this.list.indexOf(item)}},{key:"each",value:function(callback){this.list.forEach(callback)}},{key:"eachNode",value:function(callback){this.list.filter(function(item){return item instanceof Node}).forEach(callback)}},{key:"eachGroup",value:function(callback){this.list.filter(function(item){return item instanceof Group$1}).forEach(callback)}},{key:"getNodes",value:function(){return this.list.filter(function(item){return item instanceof Node})}},{key:"getGroups",value:function(){return this.list.filter(function(item){return item instanceof Group$1})}}]),Selected}(),NodeEditor=function(){function NodeEditor(id,container,components,menu){if(classCallCheck(this,NodeEditor),"string"!=typeof id)throw new TypeError('Value of argument "id" violates contract.\n\nExpected:\nstring\n\nGot:\n'+_inspect$9(id));if(!(container instanceof HTMLElement))throw new TypeError('Value of argument "container" violates contract.\n\nExpected:\nHTMLElement\n\nGot:\n'+_inspect$9(container));if(!Array.isArray(components)||!components.every(function(item){return item instanceof Component}))throw new TypeError('Value of argument "components" violates contract.\n\nExpected:\nComponent[]\n\nGot:\n'+_inspect$9(components));if(!(menu instanceof ContextMenu))throw new TypeError('Value of argument "menu" violates contract.\n\nExpected:\nContextMenu\n\nGot:\n'+_inspect$9(menu));if(!Utils.isValidId(id))throw new Error("ID should be valid to name@0.1.0 format");this.id=id,this._id=Math.random().toString(36).substr(2,9),this.components=components,this.view=new EditorView(this,container,menu),this.eventListener=new EventListener,this.selected=new Selected,this.history=new History(this),this.nodes=[],this.groups=[],this.readOnly=!1,this.view.resize()}return createClass(NodeEditor,[{key:"addNode",value:function(node){var mousePlaced=arguments.length>1&&arguments[1]!==undefined&&arguments[1];if(!(node instanceof Node))throw new TypeError('Value of argument "node" violates contract.\n\nExpected:\nNode\n\nGot:\n'+_inspect$9(node));this.eventListener.trigger("nodecreate",node)&&(mousePlaced&&(node.position=this.view.mouse),this.nodes.push(node),this.eventListener.trigger("change"),this.history.add(this.addNode.bind(this),this.removeNode.bind(this),[node]))}},{key:"addGroup",value:function(group){if(!(group instanceof Group$1))throw new TypeError('Value of argument "group" violates contract.\n\nExpected:\nGroup\n\nGot:\n'+_inspect$9(group));this.eventListener.trigger("groupcreate",group)&&(this.groups.push(group),this.eventListener.trigger("change")),this.view.update()}},{key:"removeNode",value:function(node){var _this=this;if(!(node instanceof Node))throw new TypeError('Value of argument "node" violates contract.\n\nExpected:\nNode\n\nGot:\n'+_inspect$9(node));var index=this.nodes.indexOf(node);this.eventListener.trigger("noderemove",node)&&(node.getConnections().forEach(function(c){return _this.removeConnection(c)}),this.nodes.splice(index,1),this.eventListener.trigger("change"),this.history.add(this.removeNode.bind(this),this.addNode.bind(this),[node])),this.view.update()}},{key:"removeGroup",value:function(group){if(!(group instanceof Group$1))throw new TypeError('Value of argument "group" violates contract.\n\nExpected:\nGroup\n\nGot:\n'+_inspect$9(group));this.eventListener.trigger("groupremove",group)&&(group.remove(),this.groups.splice(this.groups.indexOf(group),1),this.eventListener.trigger("change")),this.view.update()}},{key:"connect",value:function(output,input){if(!(output instanceof Output||output instanceof Connection))throw new TypeError('Value of argument "output" violates contract.\n\nExpected:\nOutput | Connection\n\nGot:\n'+_inspect$9(output));if(!(null==input||input instanceof Input))throw new TypeError('Value of argument "input" violates contract.\n\nExpected:\n?Input\n\nGot:\n'+_inspect$9(input));if(output instanceof Connection&&(input=output.input,output=output.output),this.eventListener.trigger("connectioncreate",{output:output,input:input}))try{var connection=output.connectTo(input);this.eventListener.trigger("change"),this.history.add(this.connect.bind(this),this.removeConnection.bind(this),[connection])}catch(e){console.warn(e),this.eventListener.trigger("error",e)}this.view.update()}},{key:"removeConnection",value:function(connection){if(!(connection instanceof Connection))throw new TypeError('Value of argument "connection" violates contract.\n\nExpected:\nConnection\n\nGot:\n'+_inspect$9(connection));this.eventListener.trigger("connectionremove",connection)&&(connection.remove(),this.eventListener.trigger("change"),this.history.add(this.removeConnection.bind(this),this.connect.bind(this),[connection])),this.view.update()}},{key:"selectNode",value:function(node){var accumulate=arguments.length>1&&arguments[1]!==undefined&&arguments[1];if(!(node instanceof Node))throw new TypeError('Value of argument "node" violates contract.\n\nExpected:\nNode\n\nGot:\n'+_inspect$9(node));if("boolean"!=typeof accumulate)throw new TypeError('Value of argument "accumulate" violates contract.\n\nExpected:\nboolean\n\nGot:\n'+_inspect$9(accumulate));if(-1===this.nodes.indexOf(node))throw new Error("Node not exist in list");this.eventListener.trigger("nodeselect",node)&&this.selected.add(node,accumulate),this.view.update()}},{key:"selectGroup",value:function(group){var accumulate=arguments.length>1&&arguments[1]!==undefined&&arguments[1];if(!(group instanceof Group$1))throw new TypeError('Value of argument "group" violates contract.\n\nExpected:\nGroup\n\nGot:\n'+_inspect$9(group));if("boolean"!=typeof accumulate)throw new TypeError('Value of argument "accumulate" violates contract.\n\nExpected:\nboolean\n\nGot:\n'+_inspect$9(accumulate));if(-1===this.groups.indexOf(group))throw new Error("Group not exist in list");this.eventListener.trigger("groupselect",group)&&this.selected.add(group,accumulate),this.view.update()}},{key:"keyDown",value:function(){if(!this.readOnly)switch(d3.event.keyCode){case 46:this.selected.eachNode(this.removeNode.bind(this)),this.selected.eachGroup(this.removeGroup.bind(this)),this.view.update();break;case 71:var nodes=this.selected.getNodes();nodes.length>0&&this.addGroup(new Group$1("Group",{nodes:nodes}));break;case 90:d3.event.ctrlKey&&d3.event.shiftKey?this.history.redo():d3.event.ctrlKey&&this.history.undo()}}},{key:"clear",value:function(){this.nodes.splice(0,this.nodes.length),this.groups.splice(0,this.groups.length)}},{key:"toJSON",value:function(){var nodes={},groups={};return this.nodes.forEach(function(node){return nodes[node.id]=node.toJSON()}),this.groups.forEach(function(group){return groups[group.id]=group.toJSON()}),{id:this.id,nodes:nodes,groups:groups}}},{key:"fromJSON",value:function(json){var checking,nodes,_this2=this;return regeneratorRuntime.async(function(_context2){for(;;)switch(_context2.prev=_context2.next){case 0:if(json instanceof Object){_context2.next=2;break}throw new TypeError('Value of argument "json" violates contract.\n\nExpected:\nObject\n\nGot:\n'+_inspect$9(json));case 2:if(checking=Utils.validate(this.id,json),checking.success){_context2.next=7;break}return this.eventListener.trigger("error",checking.msg),console.warn(checking.msg),_context2.abrupt("return",!1);case 7:return this.eventListener.persistent=!1,this.clear(),nodes={},_context2.prev=10,_context2.next=13,regeneratorRuntime.awrap(Promise.all(Object.keys(json.nodes).map(function(id){var node,component;return regeneratorRuntime.async(function(_context){for(;;)switch(_context.prev=_context.next){case 0:if(node=json.nodes[id],component=_this2.components.find(function(c){return c.name===node.title})){_context.next=4;break}throw"Component "+node.title+" was not found";case 4:return _context.next=6,regeneratorRuntime.awrap(Node.fromJSON(component,node));case 6:nodes[id]=_context.sent,_this2.addNode(nodes[id]);case 8:case"end":return _context.stop()}},null,_this2)})));case 13:Object.keys(json.nodes).forEach(function(id){var jsonNode=json.nodes[id],node=nodes[id];jsonNode.outputs.forEach(function(outputJson,i){outputJson.connections.forEach(function(jsonConnection){var nodeId=jsonConnection.node,inputIndex=jsonConnection.input,targetInput=nodes[nodeId].inputs[inputIndex];_this2.connect(node.outputs[i],targetInput)})})}),"object"===_typeof(json.groups)&&Object.keys(json.groups).forEach(function(id){var group=Group$1.fromJSON(json.groups[id]);json.groups[id].nodes.forEach(function(nodeId){var node=nodes[nodeId];group.addNode(node)}),_this2.addGroup(group)}),_context2.next=22;break;case 17:return _context2.prev=17,_context2.t0=_context2["catch"](10),console.warn(_context2.t0),this.eventListener.trigger("error",_context2.t0),_context2.abrupt("return",!1);case 22:return this.view.update(),this.eventListener.persistent=!0,_context2.abrupt("return",!0);case 25:case"end":return _context2.stop()}},null,this,[[10,17]])}}]),NodeEditor}(),Task=function(){function Task(inputs,action){var _this=this;classCallCheck(this,Task),this.inputs=inputs,this.action=action,this.next=[],this.outputData=null,this.closed=[],this.getOptions().forEach(function(input){input.forEach(function(con){con.task.next.push({index:con.index,task:_this})})})}return createClass(Task,[{key:"getOptions",value:function(){return this.inputs.filter(function(input){return input[0]&&input[0].task})}},{key:"getOutputs",value:function(){return this.inputs.filter(function(input){return input[0]&&input[0].get})}},{key:"reset",value:function(){this.outputData=null}},{key:"run",value:function(data){var _this2=this,inputs=this.getOutputs().map(function(input){return input.map(function(con){if(con)return con.run(),con.get()})});this.outputData||(this.outputData=this.action(inputs,data),this.next.filter(function(f){return!_this2.closed.includes(f.index)}).forEach(function(f){return f.task.run()}))}},{key:"option",value:function(index){return{task:this,index:index}}},{key:"output",value:function(index){var task=this;return{run:task.run.bind(task),get:function(){return task.outputData[index]}}}}]),Task}();!function(global){function wrap(innerFn,outerFn,self,tryLocsList){var protoGenerator=outerFn&&outerFn.prototype instanceof Generator?outerFn:Generator,generator=Object.create(protoGenerator.prototype),context=new Context(tryLocsList||[]);return generator._invoke=makeInvokeMethod(innerFn,self,context),generator}function tryCatch(fn,obj,arg){try{return{type:"normal",arg:fn.call(obj,arg)}}catch(err){return{type:"throw",arg:err}}}function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}function defineIteratorMethods(prototype){["next","throw","return"].forEach(function(method){prototype[method]=function(arg){return this._invoke(method,arg)}})}function AsyncIterator(generator){function invoke(method,arg,resolve,reject){var record=tryCatch(generator[method],generator,arg);if("throw"!==record.type){var result=record.arg,value=result.value;return value&&"object"===(void 0===value?"undefined":_typeof(value))&&hasOwn.call(value,"__await")?Promise.resolve(value.__await).then(function(value){invoke("next",value,resolve,reject)},function(err){invoke("throw",err,resolve,reject)}):Promise.resolve(value).then(function(unwrapped){result.value=unwrapped,resolve(result)},reject)}reject(record.arg)}function enqueue(method,arg){function callInvokeWithMethodAndArg(){return new Promise(function(resolve,reject){invoke(method,arg,resolve,reject)})}return previousPromise=previousPromise?previousPromise.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}var previousPromise;this._invoke=enqueue}function makeInvokeMethod(innerFn,self,context){var state=GenStateSuspendedStart;return function(method,arg){if(state===GenStateExecuting)throw new Error("Generator is already running");if(state===GenStateCompleted){if("throw"===method)throw arg;return doneResult()}for(context.method=method,context.arg=arg;;){var delegate=context.delegate;if(delegate){var delegateResult=maybeInvokeDelegate(delegate,context);if(delegateResult){if(delegateResult===ContinueSentinel)continue;return delegateResult}}if("next"===context.method)context.sent=context._sent=context.arg;else if("throw"===context.method){if(state===GenStateSuspendedStart)throw state=GenStateCompleted,context.arg;context.dispatchException(context.arg)}else"return"===context.method&&context.abrupt("return",context.arg);state=GenStateExecuting;var record=tryCatch(innerFn,self,context);if("normal"===record.type){if(state=context.done?GenStateCompleted:GenStateSuspendedYield,record.arg===ContinueSentinel)continue;return{value:record.arg,done:context.done}}"throw"===record.type&&(state=GenStateCompleted,context.method="throw",context.arg=record.arg)}}}function maybeInvokeDelegate(delegate,context){var method=delegate.iterator[context.method];if(method===undefined){if(context.delegate=null,"throw"===context.method){if(delegate.iterator["return"]&&(context.method="return",context.arg=undefined,maybeInvokeDelegate(delegate,context),"throw"===context.method))return ContinueSentinel;context.method="throw",context.arg=new TypeError("The iterator does not provide a 'throw' method")}return ContinueSentinel}var record=tryCatch(method,delegate.iterator,context.arg);if("throw"===record.type)return context.method="throw",context.arg=record.arg,context.delegate=null,ContinueSentinel;var info=record.arg;return info?info.done?(context[delegate.resultName]=info.value,context.next=delegate.nextLoc,"return"!==context.method&&(context.method="next",context.arg=undefined),context.delegate=null,ContinueSentinel):info:(context.method="throw",context.arg=new TypeError("iterator result is not an object"),context.delegate=null,ContinueSentinel)}function pushTryEntry(locs){var entry={tryLoc:locs[0]};1 in locs&&(entry.catchLoc=locs[1]),2 in locs&&(entry.finallyLoc=locs[2],entry.afterLoc=locs[3]),this.tryEntries.push(entry)}function resetTryEntry(entry){var record=entry.completion||{};record.type="normal",delete record.arg,entry.completion=record}function Context(tryLocsList){this.tryEntries=[{tryLoc:"root"}],tryLocsList.forEach(pushTryEntry,this),this.reset(!0)}function values(iterable){if(iterable){var iteratorMethod=iterable[iteratorSymbol];if(iteratorMethod)return iteratorMethod.call(iterable);if("function"==typeof iterable.next)return iterable;if(!isNaN(iterable.length)){var i=-1,next=function next(){for(;++i<iterable.length;)if(hasOwn.call(iterable,i))return next.value=iterable[i],next.done=!1,next;return next.value=undefined,next.done=!0,next};return next.next=next}}return{next:doneResult}}function doneResult(){return{value:undefined,done:!0}}var undefined,Op=Object.prototype,hasOwn=Op.hasOwnProperty,$Symbol="function"==typeof Symbol?Symbol:{},iteratorSymbol=$Symbol.iterator||"@@iterator",asyncIteratorSymbol=$Symbol.asyncIterator||"@@asyncIterator",toStringTagSymbol=$Symbol.toStringTag||"@@toStringTag",inModule="object"===("undefined"==typeof module?"undefined":_typeof(module)),runtime=global.regeneratorRuntime;if(runtime)return void(inModule&&(module.exports=runtime));runtime=global.regeneratorRuntime=inModule?module.exports:{},runtime.wrap=wrap;var GenStateSuspendedStart="suspendedStart",GenStateSuspendedYield="suspendedYield",GenStateExecuting="executing",GenStateCompleted="completed",ContinueSentinel={},IteratorPrototype={};IteratorPrototype[iteratorSymbol]=function(){return this};var getProto=Object.getPrototypeOf,NativeIteratorPrototype=getProto&&getProto(getProto(values([])));NativeIteratorPrototype&&NativeIteratorPrototype!==Op&&hasOwn.call(NativeIteratorPrototype,iteratorSymbol)&&(IteratorPrototype=NativeIteratorPrototype);var Gp=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(IteratorPrototype);GeneratorFunction.prototype=Gp.constructor=GeneratorFunctionPrototype,GeneratorFunctionPrototype.constructor=GeneratorFunction,GeneratorFunctionPrototype[toStringTagSymbol]=GeneratorFunction.displayName="GeneratorFunction",runtime.isGeneratorFunction=function(genFun){var ctor="function"==typeof genFun&&genFun.constructor;return!!ctor&&(ctor===GeneratorFunction||"GeneratorFunction"===(ctor.displayName||ctor.name))},runtime.mark=function(genFun){return Object.setPrototypeOf?Object.setPrototypeOf(genFun,GeneratorFunctionPrototype):(genFun.__proto__=GeneratorFunctionPrototype,toStringTagSymbol in genFun||(genFun[toStringTagSymbol]="GeneratorFunction")),genFun.prototype=Object.create(Gp),genFun},runtime.awrap=function(arg){return{__await:arg}},defineIteratorMethods(AsyncIterator.prototype),AsyncIterator.prototype[asyncIteratorSymbol]=function(){return this},runtime.AsyncIterator=AsyncIterator,runtime.async=function(innerFn,outerFn,self,tryLocsList){var iter=new AsyncIterator(wrap(innerFn,outerFn,self,tryLocsList));return runtime.isGeneratorFunction(outerFn)?iter:iter.next().then(function(result){return result.done?result.value:iter.next()})},defineIteratorMethods(Gp),Gp[toStringTagSymbol]="Generator",Gp[iteratorSymbol]=function(){return this},Gp.toString=function(){return"[object Generator]"},runtime.keys=function(object){var keys=[];for(var key in object)keys.push(key);return keys.reverse(),function next(){for(;keys.length;){var key=keys.pop();if(key in object)return next.value=key,next.done=!1,next}return next.done=!0,next}},runtime.values=values,Context.prototype={constructor:Context,reset:function(skipTempReset){if(this.prev=0,this.next=0,this.sent=this._sent=undefined,this.done=!1,this.delegate=null,this.method="next",this.arg=undefined,this.tryEntries.forEach(resetTryEntry),!skipTempReset)for(var name in this)"t"===name.charAt(0)&&hasOwn.call(this,name)&&!isNaN(+name.slice(1))&&(this[name]=undefined)},stop:function(){this.done=!0;var rootEntry=this.tryEntries[0],rootRecord=rootEntry.completion;if("throw"===rootRecord.type)throw rootRecord.arg;return this.rval},dispatchException:function(exception){function handle(loc,caught){return record.type="throw",record.arg=exception,context.next=loc,caught&&(context.method="next",context.arg=undefined),!!caught}if(this.done)throw exception;for(var context=this,i=this.tryEntries.length-1;i>=0;--i){var entry=this.tryEntries[i],record=entry.completion;if("root"===entry.tryLoc)return handle("end");if(entry.tryLoc<=this.prev){var hasCatch=hasOwn.call(entry,"catchLoc"),hasFinally=hasOwn.call(entry,"finallyLoc");if(hasCatch&&hasFinally){if(this.prev<entry.catchLoc)return handle(entry.catchLoc,!0);if(this.prev<entry.finallyLoc)return handle(entry.finallyLoc)}else if(hasCatch){if(this.prev<entry.catchLoc)return handle(entry.catchLoc,!0)}else{if(!hasFinally)throw new Error("try statement without catch or finally");if(this.prev<entry.finallyLoc)return handle(entry.finallyLoc)}}}},abrupt:function(type,arg){for(var i=this.tryEntries.length-1;i>=0;--i){var entry=this.tryEntries[i];if(entry.tryLoc<=this.prev&&hasOwn.call(entry,"finallyLoc")&&this.prev<entry.finallyLoc){var finallyEntry=entry;break}}finallyEntry&&("break"===type||"continue"===type)&&finallyEntry.tryLoc<=arg&&arg<=finallyEntry.finallyLoc&&(finallyEntry=null);var record=finallyEntry?finallyEntry.completion:{};return record.type=type,record.arg=arg,finallyEntry?(this.method="next",this.next=finallyEntry.finallyLoc,ContinueSentinel):this.complete(record)},complete:function(record,afterLoc){if("throw"===record.type)throw record.arg;return"break"===record.type||"continue"===record.type?this.next=record.arg:"return"===record.type?(this.rval=this.arg=record.arg,this.method="return",this.next="end"):"normal"===record.type&&afterLoc&&(this.next=afterLoc),ContinueSentinel},finish:function(finallyLoc){for(var i=this.tryEntries.length-1;i>=0;--i){var entry=this.tryEntries[i];if(entry.finallyLoc===finallyLoc)return this.complete(entry.completion,entry.afterLoc),resetTryEntry(entry),ContinueSentinel}},"catch":function(tryLoc){for(var i=this.tryEntries.length-1;i>=0;--i){var entry=this.tryEntries[i];if(entry.tryLoc===tryLoc){var record=entry.completion;if("throw"===record.type){var thrown=record.arg;resetTryEntry(entry)}return thrown}}throw new Error("illegal catch attempt")},delegateYield:function(iterable,resultName,nextLoc){return this.delegate={iterator:values(iterable),resultName:resultName,nextLoc:nextLoc},"next"===this.method&&(this.arg=undefined),ContinueSentinel}}}(function(){return this}()||Function("return this")()),exports.Component=Component,exports.ContextMenu=ContextMenu,exports.Control=Control,exports.Diff=Diff,exports.NodeEditor=NodeEditor,exports.Engine=Engine,exports.Group=Group$1,exports.Input=Input,exports.Node=Node,exports.Output=Output,exports.Socket=Socket,exports.Task=Task,exports.Module=Module,exports.ModuleManager=ModuleManager,Object.defineProperty(exports,"__esModule",{value:!0})});